{% extends "layout.njk" %}
{% import 'includes/countries.njk' as macros %}

{% set usualResidentialAddressKey = "usual_residential_address" %}

{% block backLink %}
  {% set hrefValue = props.previousUrl %}

  {% if props.data.cache.ura_territory_choice == "overseas" %}
    {% set hrefValue = props.currentUrl | replace(props.pageType, props.data.territoryPageType) %}
  {% endif %}

  {{ govukBackLink({
    text: i18n.links.back,
    attributes: {
      "data-event-id": "back-link"
    },
    href: hrefValue
  }) }}
{% endblock %}

{% if props.data.address %}
  {% set address = props.data.address %}
{% elif props.data.cache[usualResidentialAddressKey] %}
  {% set address = props.data.cache[usualResidentialAddressKey] %}
{% elif props.data.generalPartner.data.usual_residential_address %}
  {% set address = props.data.generalPartner.data.usual_residential_address %}
{% else %}
  {% set address = {} %}
{% endif %}

{% set pageTitle = i18n.address.enterAddress.generalPartner.usualResidentialAddress.title %}
{% set publicRegisterInformationLine1 = i18n.address.enterAddress.generalPartner.usualResidentialAddress.publicInformationLine1 %}

{% if props.data.cache.ura_territory_choice %}
  {% set isOverseas = props.data.cache.ura_territory_choice == "overseas" %}
{% else %}
  {% set isOverseas = address.overseas %}
{% endif %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      {% include "includes/errors.njk" %}
      {% include "includes/general-partner-name.njk" %}

      <fieldset class="govuk-fieldset">
        <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">
            <h1 class="govuk-heading-xl">
            {{ pageTitle }}
            </h1>
        </legend>
      </fieldset>
      
      <form class="form" method="post">
        <input type="hidden" name="pageType" value={{ props.pageType }}>
          {% include "includes/csrf_token.njk" %}
          
          {% if isOverseas %}
            {% include "pages/address/enter-address-fields.njk" %}

            {{ govukInput({
              label: {
                text: i18n.address.enterAddress.generalPartner.usualResidentialAddress.postcodeOptional
              },
              errorMessage: props.errors.postal_code if props.errors,
              classes: "govuk-input--width-10",
              id: "postal_code",
              name: "postal_code",
              value: address.postal_code,
              attributes: {
                oninput: "validateLength(this, 15, '" + i18n.address.enterAddress.errorMessages.postcodeLength | escape + "');"
              }
            }) }}

            {% set countryFormId = "country" %}
            {% set countryFormName = "country" %}
            {% set countryText = i18n.address.enterAddress.country %}
            {% set countryFormValue = address.country %}
            {% set countryField = address.country %}
            {% set countryFont = "govuk-!-font-weight-regular"%}
            {{ macros.getSpecifiedCountryList(i18n, "OVERSEAS", countryFormId, countryText, countryFont, countryFormValue, countryErrorMessage) }}

          {% else %}
            {% include "pages/address/enter-address-common-fields.njk" %}
          {% endif %}
          
          {% include "includes/public-register-information.njk" %}

          {% include "includes/save-and-continue-button.njk" %}
        </form>
    </div>
  </div> 
{% endblock %}
