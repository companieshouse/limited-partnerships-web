{% macro formatAddress(address, isIncludingCountry, i18n) %}
  {% set premises = '' %}
  {% set address_line_1 = '' %}
  {% set address_line_2 = '' %}
  {% set locality = '' %}
  {% set region = '' %}
  {% set country = '' %}

  {% if address.premises %}
    {% set premises = capitalizeEachWord(address.premises) %}
  {% endif %}

  {% if address.address_line_1 %} 
    {% set address_line_1 = capitalizeEachWord(address.address_line_1) %} 
  {% endif %}

  {% if address.address_line_2 %} 
    {% set address_line_2 = capitalizeEachWord(address.address_line_2) %} 
  {% endif %}

  {% if address.locality %} 
    {% set locality = capitalizeEachWord(address.locality) %} 
  {% endif %}

  {% if address.region %}
    {% set region = capitalizeEachWord(address.region) %}
  {% endif %}

  {% if address.country and isIncludingCountry %} 
    {% set country = i18n.countries[makeCamelCase(address.country)] %}
  {% endif %}

  {# Format the address by combining the available fields, can't use string concatenation as it escapes chars eg. apostrophe #}
  {# and has to be on one line as macros preserve spacing, meaning that it will render ok on page if output on separate lines but when viewing html in tests it will be spread over multiple lines #}
  {{ premises }} {% if address_line_1 %}{{ address_line_1 }}, {% endif %}{% if address_line_2 %}{{ address_line_2 }}, {% endif %}{% if locality %}{{ locality }}, {% endif %}{% if region %}{{ region }}, {% endif %}{% if country %}{{ country }}, {% endif %}{{ address.postal_code }}
{% endmacro %}

{%- macro capitalizeEachWord(str) -%}
  {%- set words = str.split(' ') -%}
  {%- set capitalizedWords = [] -%}
  {%- for word in words -%}
    {%- set subwords = word.split('-') -%}
    {%- set capitalizedSubwords = [] -%}
    {%- for subword in subwords -%}
      {%- set capitalizedSubword = subword | capitalize -%}
      {%- set capitalizedSubwords = capitalizedSubwords.concat(capitalizedSubword) -%}
    {%- endfor -%}
    {%- set capitalizedWord = capitalizedSubwords.join('-') -%}
    {%- set capitalizedWords = capitalizedWords.concat(capitalizedWord) -%}
  {%- endfor -%}
  {{- capitalizedWords.join(' ') -}}
{%- endmacro -%}

{%- macro capitalizeWord(word) -%}
  {# Capitalize a single word, handling hyphens like Guinea-Bissau #}
  {%- set parts = word.split('-') -%}
  {%- set capitalizedParts = [] -%}
  {%- for part in parts -%}
    {%- set capitalizedPart = part.charAt(0).toUpperCase() + part.slice(1) -%}
    {%- set capitalizedParts = capitalizedParts.concat(capitalizedPart) -%}
  {%- endfor -%}
  {{- capitalizedParts.join('-') -}}
{%- endmacro -%}

{%- macro formatBracketed(word) -%}
  {# Handle words in brackets like (Congo) or (DRC) #}
  {%- set content = word.slice(1, -1) -%}
  {# Short content (2-3 chars) = acronym, longer = regular word #}
  {%- if content.length <= 3 -%}
    {{- '(' + content.toUpperCase() + ')' -}}
  {%- else -%}
    {{- '(' + content.charAt(0).toUpperCase() + content.slice(1).toLowerCase() + ')' -}}
  {%- endif -%}
{%- endmacro -%}

{%- macro formatNationality(str, i18n) -%}
  {%- set localeStr = i18n.nationalities[makeCamelCase(str)] -%}
  {%- set exceptions = ['of', 'the', 'and', 'citizen'] -%}
  {%- set words = localeStr.split(' ') -%}
  {%- set result = [] -%}

  {# Temporary while waiting for welsh translations - need to handle 'WELSH -' keyword #}
  {%- if words[0] === "WELSH" -%}    
    {%- set  subset = [] -%}
    {%- set index = 0 %}
    {%- for word in words -%}
      {%- if index > 1 -%}
        {% set subset = (subset.push(word), subset) %}
      {%- else -%}
        {%- set result = result.concat(word) -%}   
      {%- endif -%}
      {%- set index = index + 1 %}
    {%- endfor -%}
    {%- set words = subset %}
  {%- endif -%}
  
  {%- for word in words -%}
    {%- if word.startsWith('(') and word.endsWith(')') -%}
      {%- set result = result.concat(formatBracketed(word)) -%}
    {%- elif loop.first or exceptions.indexOf(word.toLowerCase()) === -1 -%}
      {%- set result = result.concat(capitalizeWord(word.toLowerCase())) -%}
    {%- else -%}
      {%- set result = result.concat(word.toLowerCase()) -%}
    {%- endif -%}
  {%- endfor -%}
  {{- result.join(' ') -}}
{%- endmacro -%}

{%- macro buildFormattedListFromArray(capitalContributionSubTypesMap, array) -%}
  {%- set returnValue = [] -%}  
    {%- for item in array -%}
    {%- set returnValue = returnValue.concat(capitalContributionSubTypesMap[item]) -%}
  {%- endfor -%}
  {{- returnValue.join(' / ') -}}
{%- endmacro -%}

{% macro mapTerm(term, i18n) %}
  {% set termMap = {
    "BY_AGREEMENT": i18n.termPage.byAgreement,
    "UNTIL_DISSOLUTION": i18n.termPage.untilDissolution,
    "NONE": i18n.termPage.noTerm
  } %}

  {% set term = termMap[term] %}

  {{ term }}
{% endmacro %}

{# Required as keys for looking up the locale #}
{%- macro makeCamelCase(str) -%}
  {%- set str = str.replaceAll("-", " ") -%}   
  {%- set str = str.replaceAll(",", " ") -%}   
  {%- set str = str.replaceAll("(", " ") -%}   
  {%- set str = str.replaceAll(")", " ") -%}   
  {%- set str = str.replaceAll(".", " ") -%}   

  {%- set words = str.split(' ') -%}
  {%- set result = [] -%}

  {%- for word in words -%}
    {%- if loop.first -%}
      {%- set result = result.concat(word.toLowerCase()) -%}
    {%- else -%}
      {%- set result = result.concat(capitalizeWord(word.toLowerCase())) -%} 
    {%- endif -%}
  {%- endfor -%}

  {{- result.join('') -}}
{%- endmacro -%}
